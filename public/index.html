<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>캔버스 자동 분류기</title>
  <style>
    body{
      margin:0;
      padding:40px 20px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
        "Apple SD Gothic Neo","Noto Sans KR",Arial,sans-serif;
      background:#ffffff;
      color:#111;
    }
    .wrap{
      max-width:760px;
      margin:0 auto;
    }
    h1{
      margin:0 0 10px;
      font-size:32px;
      font-weight:700;
      letter-spacing:-0.5px;
    }
    .desc{
      margin:0 0 22px;
      color:#555;
      font-size:15px;
      line-height:1.6;
    }

    .box{
      border:1px solid #e6e6e6;
      border-radius:12px;
      padding:20px;
      background:#fafafa;
    }

    .row{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    input[type="file"]{
      font-size:14px;
    }

    .filename{
      font-size:14px;
      color:#666;
      word-break:break-all;
    }

    /* ✅ 항상 노출되는 안내문 (이번 변경점) */
    .notice{
      margin-top:14px;
      padding:12px 14px;
      background:#ffffff;
      border:1px solid #eeeeee;
      border-radius:10px;
      font-size:13px;
      line-height:1.6;
      color:#444;
    }
    .notice strong{
      color:#000;
      font-weight:700;
    }
    .notice .warn{
      color:#c00000;
      font-weight:700;
    }

    .status{
      margin-top:14px;
      font-size:14px;
      min-height:20px;
    }
    .status.ok{
      color:#0a7a27;
      font-weight:700;
    }
    .status.err{
      color:#c00000;
      font-weight:700;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>캔버스 자동 분류기</h1>
    <p class="desc">
      엑셀 파일을 선택하면 자동으로 분류된 결과 파일이 다운로드됩니다.
    </p>

    <div class="box">
      <div class="row">
        <input id="fileInput" type="file" accept="*/*" />
        <div id="fileName" class="filename"></div>
      </div>

      <!-- ✅ 변경점: 형식 경고 문구 항상 노출 -->
      <div class="notice">
        <span class="warn">주의</span><br/>
        업로드한 엑셀 파일의 <strong>열 구성·헤더 형식</strong>이 기존 설정과 다를 경우
        자동 분류가 실패할 수 있습니다.<br/>
        예: <strong>ITEM NO / DESCRIPTION / QUANTITY / CTN</strong> 컬럼이 없거나
        위치가 크게 다른 경우
      </div>

      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const statusEl = document.getElementById("status");
    const fileNameEl = document.getElementById("fileName");

    fileInput.addEventListener("change", async () => {
      statusEl.textContent = "";
      statusEl.className = "status";

      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      fileNameEl.textContent = file.name;

      const formData = new FormData();
      formData.append("file", file);

      try {
        statusEl.textContent = "업로드 중…";

        const res = await fetch("/upload", {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          let msg = "처리 실패";
          try {
            const j = await res.json();
            msg = j?.message || j?.error || msg;
          } catch (_) {}
          statusEl.className = "status err";
          statusEl.textContent = "실패: " + msg;
          return;
        }

        const blob = await res.blob();

        let filename = "분류결과.xlsx";
        const cd = res.headers.get("Content-Disposition") || "";
        const m = cd.match(/filename\*\=UTF-8''([^;]+)/i);
        if (m && m[1]) filename = decodeURIComponent(m[1]);

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        statusEl.className = "status ok";
        statusEl.textContent = "변환 완료! 파일이 다운로드되었습니다.";
      } catch (e) {
        statusEl.className = "status err";
        statusEl.textContent = "실패: 서버 또는 네트워크 오류";
        console.error(e);
      } finally {
        fileInput.value = "";
      }
    });
  </script>
</body>
</html>
